<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zona Azul Digital - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .admin-card {
            transition: all 0.3s ease;
        }
        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-container {
            position: relative;
            height: 200px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="bg-slate-800 shadow-lg">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center">
                        <i data-feather="settings" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white">Admin ZA</h1>
                        <p class="text-xs text-slate-300">Painel Administrativo</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="refreshDataBtn" class="p-2 rounded-full hover:bg-slate-700 transition-colors">
                        <i data-feather="refresh-cw" class="w-5 h-5 text-white"></i>
                    </button>
                    <button id="logoutBtn" class="p-2 rounded-full hover:bg-slate-700 transition-colors">
                        <i data-feather="log-out" class="w-5 h-5 text-white"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Container Principal -->
    <div class="max-w-6xl mx-auto px-4 py-6">
        
        <!-- Tela de Login -->
        <div id="adminLoginScreen" class="hidden">
            <div class="glass-effect rounded-2xl p-6 mb-6 max-w-md mx-auto">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-feather="settings" class="w-10 h-10 text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Painel Administrativo</h2>
                    <p class="text-gray-600">Gerenciamento do Sistema Zona Azul</p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="adminEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="admin@prefeitura.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <input type="password" id="adminPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="••••••••">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Código de Acesso</label>
                        <input type="text" id="adminCode" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Código de administrador">
                    </div>
                    <button type="button" id="doAdminLogin" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700 transition-colors">
                        Acessar Painel
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Principal -->
        <div id="adminDashboard" class="hidden">
            
            <!-- Cards de Estatísticas -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="stat-card rounded-2xl p-6 admin-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm mb-1">Total de Usuários</p>
                            <p id="totalUsers" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <i data-feather="users" class="w-6 h-6 text-blue-600"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card rounded-2xl p-6 admin-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm mb-1">Sessões Ativas</p>
                            <p id="activeSessions" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <i data-feather="activity" class="w-6 h-6 text-green-600"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card rounded-2xl p-6 admin-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm mb-1">Receita do Dia</p>
                            <p id="dailyRevenue" class="text-2xl font-bold text-gray-800">R$ 0,00</p>
                        </div>
                        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                            <i data-feather="dollar-sign" class="w-6 h-6 text-yellow-600"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card rounded-2xl p-6 admin-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm mb-1">Multas Hoje</p>
                            <p id="dailyPenalties" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                            <i data-feather="alert-triangle" class="w-6 h-6 text-red-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos e Conteúdo -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                
                <!-- Gráfico de Receita -->
                <div class="glass-effect rounded-2xl p-6 admin-card">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Receita dos Últimos 7 Dias</h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Gráfico de Utilização -->
                <div class="glass-effect rounded-2xl p-6 admin-card">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Utilização por Zona</h3>
                    <div class="chart-container">
                        <canvas id="usageChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Abas de Navegação -->
            <div class="glass-effect rounded-2xl p-6 admin-card">
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-8">
                        <button class="tab-btn py-2 px-1 border-b-2 border-purple-600 font-medium text-sm text-purple-600" data-tab="zones">
                            Zonas
                        </button>
                        <button class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="users">
                            Usuários
                        </button>
                        <button class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="fiscals">
                            Fiscais
                        </button>
                        <button class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="transactions">
                            Transações
                        </button>
                    </nav>
                </div>

                <!-- Conteúdo das Abas -->
                <div id="tabContent">
                    <!-- Zonas -->
                    <div id="zonesTab" class="tab-content">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Gerenciar Zonas</h3>
                            <button id="addZoneBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                <i data-feather="plus" class="w-4 h-4 inline mr-2"></i>
                                Nova Zona
                            </button>
                        </div>
                        <div id="zonesList" class="space-y-3">
                            <!-- Zonas serão carregadas aqui -->
                        </div>
                    </div>

                    <!-- Usuários -->
                    <div id="usersTab" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Gerenciar Usuários</h3>
                        </div>
                        <div id="usersList" class="space-y-3">
                            <!-- Usuários serão carregados aqui -->
                        </div>
                    </div>

                    <!-- Fiscais -->
                    <div id="fiscalsTab" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Gerenciar Fiscais</h3>
                            <button id="addFiscalBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                <i data-feather="plus" class="w-4 h-4 inline mr-2"></i>
                                Novo Fiscal
                            </button>
                        </div>
                        <div id="fiscalsList" class="space-y-3">
                            <!-- Fiscais serão carregados aqui -->
                        </div>
                    </div>

                    <!-- Transações -->
                    <div id="transactionsTab" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Transações</h3>
                        </div>
                        <div id="transactionsList" class="space-y-3">
                            <!-- Transações serão carregadas aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Zona -->
        <div id="zoneModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="glass-effect rounded-2xl p-6 w-full max-w-md">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800" id="zoneModalTitle">Nova Zona</h3>
                    <button id="closeZoneModal" class="text-gray-400 hover:text-gray-600">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Zona</label>
                        <input type="text" id="zoneName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Centro Comercial">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Localização</label>
                        <input type="text" id="zoneLocation" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Rua Principal, 100-200">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor/Hora</label>
                            <input type="number" id="zonePrice" step="0.01" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="5.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Vagas</label>
                            <input type="number" id="zoneSpots" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="50">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Horário Início</label>
                            <input type="time" id="zoneStartTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" value="08:00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Horário Fim</label>
                            <input type="time" id="zoneEndTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" value="18:00">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tolerância (minutos)</label>
                        <input type="number" id="zoneTolerance" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="5" min="0" max="30">
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button id="cancelZone" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                        <button id="saveZone" class="flex-1 bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700 transition-colors">
                            Salvar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Fiscal -->
        <div id="fiscalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="glass-effect rounded-2xl p-6 w-full max-w-md">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Novo Fiscal</h3>
                    <button id="closeFiscalModal" class="text-gray-400 hover:text-gray-600">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                        <input type="text" id="fiscalName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="João Silva">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">CPF</label>
                        <input type="text" id="fiscalCPF" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="000.000.000-00" maxlength="14">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="fiscalEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="fiscal@prefeitura.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Matrícula</label>
                        <input type="text" id="fiscalMatricula" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="12345">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Zona de Atuação</label>
                        <select id="fiscalZone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            <option value="">Selecionar zona...</option>
                            <!-- Zonas serão carregadas aqui -->
                        </select>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button id="cancelFiscal" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400 transition-colors">
                            Cancelar
                        </button>
                        <button id="saveFiscal" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-medium hover:bg-red-700 transition-colors">
                            Salvar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notificações -->
        <div id="notification" class="hidden fixed top-20 left-4 right-4 z-50">
            <div class="glass-effect rounded-lg p-4 shadow-lg">
                <div class="flex items-center">
                    <i id="notificationIcon" class="w-6 h-6 mr-3"></i>
                    <span id="notificationMessage" class="text-gray-800"></span>
                </div>
            </div>
        </div>
    </div>

    <script src="main.js"></script>
    <script>
        // Variáveis para gráficos
        let revenueChart = null;
        let usageChart = null;
        let currentEditingZone = null;

        // Inicializar aplicação quando DOM carregar
        document.addEventListener('DOMContentLoaded', function() {
            initializeAdminApp();
            setupAdminEventListeners();
            checkAdminAuthState();
            
            // Inicializar ícones Feather
            feather.replace();
        });

        function initializeAdminApp() {
            // Configurar abas
            setupTabs();
        }

        function setupAdminEventListeners() {
            // Auth
            document.getElementById('doAdminLogin').addEventListener('click', handleAdminLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleAdminLogout);

            // Abas
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });

            // Zonas
            document.getElementById('addZoneBtn').addEventListener('click', showZoneModal);
            document.getElementById('closeZoneModal').addEventListener('click', hideZoneModal);
            document.getElementById('cancelZone').addEventListener('click', hideZoneModal);
            document.getElementById('saveZone').addEventListener('click', handleSaveZone);

            // Fiscais
            document.getElementById('addFiscalBtn').addEventListener('click', showFiscalModal);
            document.getElementById('closeFiscalModal').addEventListener('click', hideFiscalModal);
            document.getElementById('cancelFiscal').addEventListener('click', hideFiscalModal);
            document.getElementById('saveFiscal').addEventListener('click', handleSaveFiscal);

            // Atualização de dados
            document.getElementById('refreshDataBtn').addEventListener('click', loadAdminData);

            // Formatação
            document.getElementById('fiscalCPF').addEventListener('input', formatCPF);
        }

        function checkAdminAuthState() {
            if (AppState.currentUser && AppState.currentUser.tipo === 'admin') {
                showAdminDashboard();
                loadAdminData();
            } else {
                showAdminLoginScreen();
            }
        }

        function showAdminLoginScreen() {
            document.getElementById('adminLoginScreen').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        function showAdminDashboard() {
            document.getElementById('adminLoginScreen').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
        }

        async function handleAdminLogin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const code = document.getElementById('adminCode').value;

            if (!email || !password || !code) {
                showNotification('Preencha todos os campos', 'error');
                return;
            }

            // Para demo, vamos criar um admin se não existir
            let adminUser = db.findUserByEmail(email);
            
            if (!adminUser) {
                // Criar admin de demonstração
                adminUser = db.create('users', {
                    nome: 'Administrador',
                    cpf: '00000000000',
                    email: email,
                    telefone: '(00) 00000-0000',
                    senha: password,
                    saldo_creditos: 0,
                    tipo: 'admin'
                });
            }

            // Verificar credenciais (simplificado para demo)
            if (adminUser.senha !== password || adminUser.tipo !== 'admin') {
                showNotification('Credenciais inválidas ou acesso negado', 'error');
                return;
            }

            // Criar sessão
            AuthService.createSession(adminUser);
            showAdminDashboard();
            loadAdminData();
            showNotification('Login realizado com sucesso!', 'success');
        }

        function handleAdminLogout() {
            AuthService.logout();
            showAdminLoginScreen();
            showNotification('Logout realizado', 'info');
        }

        function setupTabs() {
            switchTab('zones'); // Aba padrão
        }

        function switchTab(tabName) {
            // Atualizar botões das abas
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-purple-600', 'text-purple-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-purple-600', 'text-purple-600');

            // Mostrar conteúdo da aba
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');

            // Carregar dados da aba
            switch(tabName) {
                case 'zones':
                    loadZones();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'fiscals':
                    loadFiscals();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
            }
        }

        async function loadAdminData() {
            if (!AdminService.isAdmin()) return;

            try {
                const stats = AdminService.getSystemStats();
                
                // Atualizar estatísticas
                document.getElementById('totalUsers').textContent = stats.totalUsers;
                document.getElementById('activeSessions').textContent = stats.activeSessions;
                document.getElementById('dailyRevenue').textContent = formatCurrency(stats.todayRevenue);
                document.getElementById('dailyPenalties').textContent = '0'; // Implementar contador de multas

                // Criar gráficos
                createRevenueChart();
                createUsageChart();
                
                showNotification('Dados atualizados com sucesso!', 'success');
            } catch (error) {
                showNotification('Erro ao carregar dados: ' + error.message, 'error');
            }
        }

        function createRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Dados simulados para os últimos 7 dias
            const labels = [];
            const data = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('pt-BR', { weekday: 'short' }));
                data.push(Math.floor(Math.random() * 1000) + 200); // Valores simulados
            }

            if (revenueChart) {
                revenueChart.destroy();
            }

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Receita (R$)',
                        data: data,
                        borderColor: 'rgb(147, 51, 234)',
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createUsageChart() {
            const ctx = document.getElementById('usageChart').getContext('2d');
            
            // Dados simulados de utilização por zona
            const zones = AppState.zones;
            const data = zones.map(zone => ({
                zone: zone.nome,
                usage: Math.floor(Math.random() * 100) // Porcentagem simulada
            }));

            if (usageChart) {
                usageChart.destroy();
            }

            usageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.zone),
                    datasets: [{
                        label: 'Utilização (%)',
                        data: data.map(d => d.usage),
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: 'rgb(34, 197, 94)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function loadZones() {
            const zonesList = document.getElementById('zonesList');
            const zones = db.getAll('zones');

            zonesList.innerHTML = '';

            if (zones.length === 0) {
                zonesList.innerHTML = '<p class="text-gray-500 text-center">Nenhuma zona cadastrada</p>';
                return;
            }

            zones.forEach(zone => {
                const zoneCard = document.createElement('div');
                zoneCard.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
                zoneCard.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-gray-800">${zone.nome}</h4>
                            <span class="text-green-600 font-bold">${formatCurrency(zone.valor_hora)}/h</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">${zone.localizacao}</p>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>${zone.horario_inicio} - ${zone.horario_fim}</span>
                            <span>${zone.vagas || 0} vagas</span>
                            <span class="px-2 py-1 rounded ${zone.status === 'ativa' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${zone.status === 'ativa' ? 'Ativa' : 'Inativa'}</span>
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button onclick="editZone('${zone.id}')" class="text-blue-600 hover:text-blue-700">
                            <i data-feather="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteZone('${zone.id}')" class="text-red-600 hover:text-red-700">
                            <i data-feather="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                zonesList.appendChild(zoneCard);
            });

            feather.replace();
        }

        function loadUsers() {
            const usersList = document.getElementById('usersList');
            const users = db.getAll('users').filter(user => user.tipo === 'motorista');

            usersList.innerHTML = '';

            if (users.length === 0) {
                usersList.innerHTML = '<p class="text-gray-500 text-center">Nenhum usuário cadastrado</p>';
                return;
            }

            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
                userCard.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-gray-800">${user.nome}</h4>
                            <span class="text-blue-600 font-medium">${formatCurrency(user.saldo_creditos)}</span>
                        </div>
                        <p class="text-sm text-gray-600">${user.email}</p>
                        <div class="flex items-center justify-between text-xs text-gray-500 mt-1">
                            <span>CPF: ${user.cpf}</span>
                            <span>Veículos: ${db.getByField('vehicles', 'user_id', user.id).length}</span>
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button onclick="viewUser('${user.id}')" class="text-blue-600 hover:text-blue-700">
                            <i data-feather="eye" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                usersList.appendChild(userCard);
            });

            feather.replace();
        }

        function loadFiscals() {
            const fiscalsList = document.getElementById('fiscalsList');
            const fiscals = db.getAll('users').filter(user => user.tipo === 'fiscal');

            fiscalsList.innerHTML = '';

            if (fiscals.length === 0) {
                fiscalsList.innerHTML = '<p class="text-gray-500 text-center">Nenhum fiscal cadastrado</p>';
                return;
            }

            fiscals.forEach(fiscal => {
                const fiscalCard = document.createElement('div');
                fiscalCard.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
                fiscalCard.innerHTML = `
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 mb-1">${fiscal.nome}</h4>
                        <p class="text-sm text-gray-600">${fiscal.email}</p>
                        <div class="text-xs text-gray-500 mt-1">
                            <span>CPF: ${fiscal.cpf}</span>
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button onclick="editFiscal('${fiscal.id}')" class="text-blue-600 hover:text-blue-700">
                            <i data-feather="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteFiscal('${fiscal.id}')" class="text-red-600 hover:text-red-700">
                            <i data-feather="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                fiscalsList.appendChild(fiscalCard);
            });

            feather.replace();
        }

        function loadTransactions() {
            const transactionsList = document.getElementById('transactionsList');
            const transactions = db.getAll('transactions').slice(0, 20); // Últimas 20 transações

            transactionsList.innerHTML = '';

            if (transactions.length === 0) {
                transactionsList.innerHTML = '<p class="text-gray-500 text-center">Nenhuma transação encontrada</p>';
                return;
            }

            transactions.forEach(transaction => {
                const user = db.getById('users', transaction.user_id);
                const transactionCard = document.createElement('div');
                transactionCard.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
                
                const typeColor = transaction.tipo === 'compra' ? 'text-green-600' : 
                                 transaction.tipo === 'uso' ? 'text-blue-600' : 'text-orange-600';
                
                transactionCard.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-gray-800 capitalize">${transaction.tipo}</h4>
                            <span class="font-bold ${typeColor}">${formatCurrency(transaction.valor)}</span>
                        </div>
                        <p class="text-sm text-gray-600">${user ? user.nome : 'Usuário desconhecido'}</p>
                        <div class="flex items-center justify-between text-xs text-gray-500 mt-1">
                            <span>${transaction.metodo_pagamento}</span>
                            <span>${new Date(transaction.created_at).toLocaleDateString('pt-BR')}</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <span class="px-2 py-1 rounded text-xs ${transaction.status === 'concluido' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${transaction.status}</span>
                    </div>
                `;
                transactionsList.appendChild(transactionCard);
            });

            feather.replace();
        }

        // Funções de modal de zona
        function showZoneModal() {
            currentEditingZone = null;
            document.getElementById('zoneModalTitle').textContent = 'Nova Zona';
            clearZoneForm();
            document.getElementById('zoneModal').classList.remove('hidden');
        }

        function hideZoneModal() {
            document.getElementById('zoneModal').classList.add('hidden');
            currentEditingZone = null;
        }

        function editZone(zoneId) {
            const zone = db.getById('zones', zoneId);
            if (!zone) return;

            currentEditingZone = zoneId;
            document.getElementById('zoneModalTitle').textContent = 'Editar Zona';
            
            // Preencher formulário
            document.getElementById('zoneName').value = zone.nome;
            document.getElementById('zoneLocation').value = zone.localizacao;
            document.getElementById('zonePrice').value = zone.valor_hora;
            document.getElementById('zoneSpots').value = zone.vagas || 0;
            document.getElementById('zoneStartTime').value = zone.horario_inicio;
            document.getElementById('zoneEndTime').value = zone.horario_fim;
            document.getElementById('zoneTolerance').value = zone.tolerancia_minutos;
            
            document.getElementById('zoneModal').classList.remove('hidden');
        }

        function clearZoneForm() {
            document.getElementById('zoneName').value = '';
            document.getElementById('zoneLocation').value = '';
            document.getElementById('zonePrice').value = '';
            document.getElementById('zoneSpots').value = '';
            document.getElementById('zoneStartTime').value = '08:00';
            document.getElementById('zoneEndTime').value = '18:00';
            document.getElementById('zoneTolerance').value = '5';
        }

        async function handleSaveZone() {
            const zoneData = {
                nome: document.getElementById('zoneName').value,
                localizacao: document.getElementById('zoneLocation').value,
                valor_hora: parseFloat(document.getElementById('zonePrice').value),
                vagas: parseInt(document.getElementById('zoneSpots').value) || 0,
                horario_inicio: document.getElementById('zoneStartTime').value,
                horario_fim: document.getElementById('zoneEndTime').value,
                tolerancia_minutos: parseInt(document.getElementById('zoneTolerance').value),
                dias_funcionamento: ['seg', 'ter', 'qua', 'qui', 'sex'],
                status: 'ativa'
            };

            try {
                if (currentEditingZone) {
                    await AdminService.updateZone(currentEditingZone, zoneData);
                    showNotification('Zona atualizada com sucesso!', 'success');
                } else {
                    await AdminService.createZone(zoneData);
                    showNotification('Zona criada com sucesso!', 'success');
                }
                
                hideZoneModal();
                loadZones();
                AppState.zones = db.getAll('zones').filter(zone => zone.status === 'ativa');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        function deleteZone(zoneId) {
            if (confirm('Tem certeza que deseja excluir esta zona?')) {
                try {
                    AdminService.deleteZone(zoneId);
                    loadZones();
                    AppState.zones = db.getAll('zones').filter(zone => zone.status === 'ativa');
                    showNotification('Zona excluída com sucesso!', 'success');
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            }
        }

        // Funções de modal de fiscal
        function showFiscalModal() {
            clearFiscalForm();
            document.getElementById('fiscalModal').classList.remove('hidden');
            loadZonesForFiscalSelect();
        }

        function hideFiscalModal() {
            document.getElementById('fiscalModal').classList.add('hidden');
        }

        function loadZonesForFiscalSelect() {
            const fiscalZoneSelect = document.getElementById('fiscalZone');
            fiscalZoneSelect.innerHTML = '<option value="">Selecionar zona...</option>';
            
            AppState.zones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone.id;
                option.textContent = `${zone.nome} - ${formatCurrency(zone.valor_hora)}/h`;
                fiscalZoneSelect.appendChild(option);
            });
        }

        function clearFiscalForm() {
            document.getElementById('fiscalName').value = '';
            document.getElementById('fiscalCPF').value = '';
            document.getElementById('fiscalEmail').value = '';
            document.getElementById('fiscalMatricula').value = '';
            document.getElementById('fiscalZone').value = '';
        }

        async function handleSaveFiscal() {
            const fiscalData = {
                nome: document.getElementById('fiscalName').value,
                cpf: document.getElementById('fiscalCPF').value.replace(/[^\d]/g, ''),
                email: document.getElementById('fiscalEmail').value,
                senha: 'fiscal123', // Senha padrão
                telefone: '(00) 00000-0000',
                tipo: 'fiscal'
            };

            // Validar CPF
            if (!validateCPF(fiscalData.cpf)) {
                showNotification('CPF inválido', 'error');
                return;
            }

            try {
                db.create('users', fiscalData);
                hideFiscalModal();
                loadFiscals();
                showNotification('Fiscal cadastrado com sucesso!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        function editFiscal(fiscalId) {
            showNotification('Funcionalidade em desenvolvimento', 'info');
        }

        function deleteFiscal(fiscalId) {
            if (confirm('Tem certeza que deseja excluir este fiscal?')) {
                try {
                    db.delete('users', fiscalId);
                    loadFiscals();
                    showNotification('Fiscal excluído com sucesso!', 'success');
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            }
        }

        function viewUser(userId) {
            showNotification('Funcionalidade em desenvolvimento', 'info');
        }

        // Funções auxiliares
        function formatCPF(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value.length > 9) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/(\d{3})(\d{3})/, '$1.$2');
            }
            e.target.value = value;
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const messageEl = document.getElementById('notificationMessage');
            
            // Configurar ícone e cor
            const icons = {
                success: 'check-circle text-green-500',
                error: 'x-circle text-red-500',
                warning: 'alert-circle text-yellow-500',
                info: 'info text-blue-500'
            };
            
            icon.className = `w-6 h-6 mr-3 ${icons[type]}`;
            messageEl.textContent = message;
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>